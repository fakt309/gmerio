<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="2d shooter game online. Build own fortress, destroy enemy">
    <meta name="keywords" content="2d,shooter,play,online,socket,io">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" type="image/png" href="/g/cannons/img/favicon.png">
    <link rel="stylesheet" href="/g/cannons/style/stats.css">
    <title>2d shooter game online, build own fortress, destroy enemy</title>
  </head>
  <body>

    <section class="wrapContent">

      <div class="wrapLink"><a href="/" class="linkHome">< Back to home</a></div>

      <div class="headContent">
        <div class="wrapCannon">
          <div class="imgCannon2"></div>
          <div class="imgCannon1"></div>
        </div>
        <div class="imgWall"></div>
        <div class="raitingBlock"></div>
      </div>

      <div class="bodyContent">
        <div class="navBodyContent">
          <div class="oneNavBC" active="1" id="leftButtonInventar" onclick="showRightBody(this, 'wrapInventar')">
            <!-- <div class="icoOneNavBC" style="background-image:url('/img/icoInventar.png')"></div> -->
            <div class="icoOneNavBC"></div>
            <div class="titleOneNavBC">Inventar</div>
          </div>
          <div class="oneNavBC" id="leftButtonStats" onclick="showRightBody(this, 'wrapStats')">
            <!-- <div class="icoOneNavBC" style="background-image:url('/img/icoStats.png')"></div> -->
            <div class="icoOneNavBC"></div>
            <div class="titleOneNavBC">Stats</div>
          </div>
        </div>
        <div class="rightBodyContent">
          <div class="wrapRight" id="wrapInventar" active="1">
            <div class="equipButton" ddisabled="1" onclick="equipItem()">equip</div>
            <div class="inventar"></div>
          </div>
          <div class="wrapRight" id="wrapStats" active="0">
            <!-- games ; win ; winrate; destroyed cannons ; dc/games -->
            <div class="listStats">
              <div class="oneStat">
                <div class="titleStat">Games</div>
                <div class="valStat" id="valStatsGames"></div>
              </div>
              <div class="oneStat">
                <div class="titleStat">Wins</div>
                <div class="valStat" id="valStatsWins"></div>
              </div>
              <div class="oneStat">
                <div class="titleStat">Win rate</div>
                <div class="valStat" id="valStatsWinrate"></div>
              </div>
              <div class="oneStat">
                <div class="titleStat">Destroyed cannons</div>
                <div class="valStat" id="valStatsDC"></div>
              </div>
              <div class="oneStat">
                <div class="titleStat">Destroyed cannons / games</div>
                <div class="valStat" id="valStatsDCG"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  	<script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      var socket = io();

      var allTextures = {
        cannonIco: "/g/cannons/imgcannonIco.png",
        chooseObjects: "/g/cannons/imgchooseObjects.png",
        exitAccount: "/g/cannons/imgexitAccount.png",
        explode1: "explode1.png",
        explode2: "explode2.png",
        explode3: "explode3.png",
        favicon: "favicon.png",
        icoInventar: "icoInventar.png",
        icoStats: "icoStats.png",
        imready: "imready.png",
        leftClick: "leftClick.png",
        leftSummerGrass: "leftSummerGrass.png",
        rightClick: "rightClick.png",
        rightSummerGrass: "rightSummerGrass.png",
        sky: "sky.png",
        wallIco: "wallIco.png",
        water: "water.png",
        itemcannon1: "cannon1.png",
        itemcannon2: "cannon2.png",
        itemwall: "wall.png"
      }

      var idDesigner = getCookie("idDesigner");
      if (!idDesigner || idDesigner != "") {
        for (i in allTextures) {
          //exits designer img
          var testUrl = "/img/designers/"+idDesigner+"~~"+allTextures[i];
          var http = new XMLHttpRequest();
          http.open('HEAD', testUrl, false);
          http.send();
          if (new URL(http.responseURL).pathname == testUrl) {
            allTextures[i] = "img/designers/"+idDesigner+"~~"+allTextures[i];
          } else {
            allTextures[i] = "g/cannons/img/"+allTextures[i];
          }
        }

        $("#icoico").attr("href", allTextures.favicon);
      }

      $(".icoOneNavBC").eq(0).css("background-image", "url(/"+allTextures.icoInventar+")");
      $(".icoOneNavBC").eq(1).css("background-image", "url(/"+allTextures.icoStats+")");

      var URLpath = window.location.pathname;
      var idUser = URLpath.split("/")[4];
      var dataUser = "";
      socket.emit('getUserData', idUser);
      socket.on('sendUserData', function(data) {
        if (data == "") {
          window.location.replace("/g/cannons");
        } else {
          dataUser = data.split("||");
          socket.emit('getItems', getDataUser("items"));
        }
      });

      var dataItems = "";
      socket.on('sendItems', function(data) {
        dataItems = data.split("||");

        setData();
      });

      function getDataUser(name) {
        for (var i = 0; i < dataUser.length; i++) {
          var d = dataUser[i].split("~~");
          if (d[0] == name) {
            return d[1];
          }
        }
        return false;
      }

      function getDataItems(name) {
        for (var i = 0; i < dataUser.length; i++) {
          var d = dataUser[i].split("~~");
          if (d[0] == name) {
            return d[1];
          }
        }
        return false;
      }

      function setData() {
        $(".imgCannon1").css("background-image", "url('/g/cannons/img/items/cannon1_"+getDataUser("equipItemCannon1")+".png')");
        $(".imgCannon2").css("background-image", "url('/g/cannons/img/items/cannon2_"+getDataUser("equipItemCannon2")+".png')");
        $(".imgWall").css("background-image", "url('/g/cannons/img/items/wall_"+getDataUser("equipItemWall")+".png')");
        $(".raitingBlock").html("Rating: "+getDataUser("rating"));



        if (getDataUser("id") == myid) {
          refreshInventar();
        } else {
          // $(".equipButton").css("display", "none");

          $("#leftButtonInventar").css("display", "none");

          showRightBody(document.getElementById('leftButtonStats'), 'wrapStats');
        }
      }

      function showRightBody(el, id) {
        $(".oneNavBC").attr("active", "0");
        $(".wrapRight").attr("active", "0");

        $(el).attr("active", "1");
        $("#"+id).attr("active", "1");

        if (id == "wrapInventar") {
          refreshInventar();
        } else if (id == "wrapStats") {
          refreshStats();
        }
      }

      // $(document).on("mousedown", function() {
      //   if ($("#wrapInventar").attr("active") == "1") {
          // $(".oneItem").attr("choose", "0");
          // $(".equipButton").attr("ddisabled", "1");
      //   }
      // });

      var downPressInventar = false;
      $(document).mousedown(function (e){
      	if (!$(".oneItem").is(e.target) && $(".oneItem").has(e.target).length === 0 && !$(".equipButton").is(e.target) && $(".equipButton").has(e.target).length === 0) {
      		downPressInventar = true;
      	} else {
      		downPressInventar = false;
      	}
      });
      $(document).mouseup(function (e){
      	if (!$(".oneItem").is(e.target) && $(".oneItem").has(e.target).length === 0 && !$(".equipButton").is(e.target) && $(".equipButton").has(e.target).length === 0 && downPressInventar) {
          $(".oneItem").attr("choose", "0");
          $(".equipButton").attr("ddisabled", "1");
      	} else {
      		downPressInventar = false;
      	}
      });

      $(window).resize(function() {
        if ($("#wrapInventar").attr("active") == "1") {
          setMarginInventar();
        }
      });

      function equipItem() {
        socket.emit('setItem', getDataUser("id"), $(".oneItem[choose='1']").attr("ttype")+"~~"+$(".oneItem[choose='1']").attr("nname"));
      }//sendAnwerSetItem
      socket.on('sendAnwerSetItem', function() {
        location.reload(true);
      });

      function setMarginInventar() {
        var margin = ($(".wrapRight").width()%100)/2;
        if (margin == 0) { margin = 100; }
        $(".inventar").css("margin", "50px "+margin+"px");

        $(".equipButton").css("margin-left", margin+"px");
      }

      function chooseItem(el) {
        $(".oneItem").attr("choose", "0");
        $(el).attr("choose", "1");
        $(".equipButton").attr("ddisabled", "0");
      }

      function refreshInventar() {
        $(".inventar").html("");

        for (var i = 0; i < dataItems.length; i++) {
          var currData = dataItems[i].split("~~");
          $(".inventar").append("<div onclick='chooseItem(this)' class='oneItem' ttype='"+currData[1]+"' nname='"+currData[2]+"' style='background-image:url(\"/g/cannons/img/items/"+currData[1]+"_"+currData[2]+".png\")'>");
        }
        setMarginInventar();
      }

      function refreshStats() {
        var games = getDataUser("games");
        var wins = getDataUser("win");
        var dc = getDataUser("destroyedCannons");

        $("#valStatsGames").html(games);
        $("#valStatsWins").html(wins);
        $("#valStatsWinrate").html(Math.round((wins/games)*100)+"%");
        $("#valStatsDC").html(dc);
        $("#valStatsDCG").html(Math.round((dc/games)*100)/100);
      }


      //get my id
      var myid = "";
      var mid = getCookie("mid");
      if (mid && mid != "") {
        socket.emit('decryptMail', mid);
      } else {
        $("#signButton").css("display", "flex");
      }
      socket.on('sendDecryptMail', function(answer) {
        if (answer != "!nomail") {
          answer = answer.split("|");
          myid = answer[0];
        }
      });

      //cookie
      function getCookie(name) {
        var cookie = document.cookie;
        cookie = cookie.split("; ");
        for (var i = 0; i < cookie.length; i++) {
          var oneCookie = cookie[i].split("=");
          if (name == oneCookie[0]) {
            return oneCookie[1];
          }
        }
        return false;
      }

      function removeCookie(name) {
        document.cookie = name+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      }
    </script>
  </body>
</html>
